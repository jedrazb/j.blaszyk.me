"use strict";(self.webpackChunkj_blaszyk_me=self.webpackChunkj_blaszyk_me||[]).push([[241],{8716:function(e,n,t){t.r(n),t.d(n,{default:function(){return T}});var a=t(7387),s=t(8453),r=t(6540);function o(e){const n=Object.assign({p:"p",em:"em",a:"a",h2:"h2",span:"span",ul:"ul",li:"li",h3:"h3",blockquote:"blockquote",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td"},(0,s.R)(),e.components),{ImageComponent:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ImageComponent",!0),r.createElement(r.Fragment,null,r.createElement(n.p,null,"Featured Snippets really stand out to me as a feature in Google search. They are displayed at the top of results for certain search queries, highlighting a relevant excerpt from the source webpage that often directly answers the query. This provides a great user experience when looking for an answer from a given set of documents!"),"\n",r.createElement(n.p,null,"In our scenario, let’s assume that the “knowledge” contained in a document set can be used to answer our questions. Since the answer is within our documents, it’s just a matter of finding the right passage — a ",r.createElement(n.em,null,"featured snippet")," — that addresses our query. The good news is that we can use a vector search on embedded chunks and sentences to find the answer, instead of relying on a slow and more expensive LLM to generate one. The concept of relying on embeddings for passage retrieval has been around for a while, for example, see: ",r.createElement(n.a,{href:"https://arxiv.org/abs/2004.04906",target:"_blank",rel:"nofollow noopener noreferrer"},"Dense Passage Retrieval")," paper."),"\n",r.createElement(n.p,null,"Similarly to the previous blog post, ",r.createElement(n.a,{href:"/tech-blog/question-answering-with-langchain-huggingface-and-elasticsearch/"},"Question Answering with LangChain, HuggingFace, and Elasticsearch"),", I’m using this blog as a data source together with free, open-source models and libraries to build a solution."),"\n",r.createElement(n.h2,{id:"featured-snippet",style:{position:"relative"}},r.createElement(n.a,{href:"#featured-snippet","aria-label":"featured snippet permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Featured Snippet"),"\n",r.createElement(n.p,null,"Assume that our collection contains several documents. We first split each document into text chunks of equal length, using these passages as the basic retrieval units. Each passage may contain multiple sentences and can be viewed as a sequence of tokens."),"\n",r.createElement(n.p,null,"Given a query, the featured snippet is a span of one or more sentences from one of the retrieved passages that best answers the question."),"\n",r.createElement(n.p,null,"Let’s look into the logic that allows to find the best featured snippet."),"\n",r.createElement(n.h2,{id:"data-processing-and-ingestion",style:{position:"relative"}},r.createElement(n.a,{href:"#data-processing-and-ingestion","aria-label":"data processing and ingestion permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Data Processing and Ingestion"),"\n",r.createElement(n.p,null,"I used the Elastic web crawler to crawl the content of this blog. The output is available in: ",r.createElement(n.a,{href:"https://gist.github.com/jedrazb/0c9df82143b694147e7b018370508535",target:"_blank",rel:"nofollow noopener noreferrer"},"blog-pages.jsonl"),"."),"\n",r.createElement(n.p,null,"Text content from pages is chunked, and individual chunks are embedded into 768-dimensional dense vectors using the ",r.createElement(n.a,{href:"https://huggingface.co/sentence-transformers/all-mpnet-base-v2",target:"_blank",rel:"nofollow noopener noreferrer"},"all-mpnet-base-v2")," model."),"\n",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">\n<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> HuggingFaceEmbeddings\n<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter\n\nembeddings <span class="token operator">=</span> HuggingFaceEmbeddings<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">\'sentence-transformers/all-mpnet-base-v2\'</span><span class="token punctuation">)</span>\n\ntext_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">.</span>from_tiktoken_encoder<span class="token punctuation">(</span>\n    chunk_size<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> chunk_overlap<span class="token operator">=</span><span class="token number">128</span>\n<span class="token punctuation">)</span>\ndocs <span class="token operator">=</span> loader<span class="token punctuation">.</span>load_and_split<span class="token punctuation">(</span>text_splitter<span class="token operator">=</span>text_splitter<span class="token punctuation">)</span></code></pre></div>'}}),"\n",r.createElement(n.p,null,"Chunks and their embeddings are indexed into Elasticsearch for fast retrieval."),"\n",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> langchain_elasticsearch <span class="token keyword">import</span> ElasticsearchStore\n\ndb <span class="token operator">=</span> ElasticsearchStore<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>\n    docs<span class="token punctuation">,</span>\n    embeddings<span class="token punctuation">,</span>\n    vector_query_field<span class="token operator">=</span>ES_VECTOR_FIELD<span class="token punctuation">,</span>\n    index_name<span class="token operator">=</span>ES_INDEX_NAME<span class="token punctuation">,</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token punctuation">)</span></code></pre></div>'}}),"\n",r.createElement(n.h2,{id:"document-retrieval",style:{position:"relative"}},r.createElement(n.a,{href:"#document-retrieval","aria-label":"document retrieval permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Document Retrieval"),"\n",r.createElement(n.p,null,"Embeddings play a crucial role in our architecture. Since we store chunks and their embeddings in elasticsearch, we can use kNN vector search to find the most relevant chunks for a given query."),"\n",r.createElement(n.p,null,"The ",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">retriever</code>'}})," for ES looks as follows with the Langchain library. The ",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">vector_query</code>'}})," is a kNN search function used by the retriever. ",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">embeddings.embed_query</code>'}})," represents the query as a dense vector."),"\n",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> langchain_elasticsearch <span class="token keyword">import</span> ElasticsearchRetriever\n\n<span class="token keyword">def</span> <span class="token function">vector_query</span><span class="token punctuation">(</span>search_query<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token string">"knn"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"field"</span><span class="token punctuation">:</span> ES_VECTOR_FIELD<span class="token punctuation">,</span>\n            <span class="token string">"query_vector"</span><span class="token punctuation">:</span> embeddings<span class="token punctuation">.</span>embed_query<span class="token punctuation">(</span>search_query<span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token string">"k"</span><span class="token punctuation">:</span> k<span class="token punctuation">,</span>\n            <span class="token string">"num_candidates"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'_source\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n            <span class="token string">\'text\'</span><span class="token punctuation">,</span> <span class="token string">\'metadata.title\'</span><span class="token punctuation">,</span> <span class="token string">\'metadata.url\'</span>\n        <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n\n\nretriever <span class="token operator">=</span> ElasticsearchRetriever<span class="token punctuation">.</span>from_es_params<span class="token punctuation">(</span>\n    index_name<span class="token operator">=</span>ES_INDEX_NAME<span class="token punctuation">,</span>\n    body_func<span class="token operator">=</span>vector_query<span class="token punctuation">,</span>\n    content_field<span class="token operator">=</span><span class="token string">"text"</span><span class="token punctuation">,</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token punctuation">)</span></code></pre></div>'}}),"\n",r.createElement(n.h2,{id:"snippet-selection",style:{position:"relative"}},r.createElement(n.a,{href:"#snippet-selection","aria-label":"snippet selection permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Snippet Selection"),"\n",r.createElement(n.p,null,"Our retriever returns the top 3 chunks for a given query. Each chunk is then processed to identify the best snippet using an expanding window method. This involves:"),"\n",r.createElement(n.ul,null,"\n",r.createElement(n.li,null,"Tokenizing the retrieved chunk into sentences."),"\n",r.createElement(n.li,null,"Calculating similarity scores for each sentence in the chunk (could be optimized by pre-computing sentence embeddings and storing them in the index for quick lookup)."),"\n",r.createElement(n.li,null,"Filtering out less relevant sentences using a threshold score that can be adjusted."),"\n",r.createElement(n.li,null,"Starting from the most relevant sentence, expanding the selection window to include neighboring sentences, if relevant, to form a coherent snippet."),"\n"),"\n",r.createElement(n.p,null,"Here is an example representing how similarity scores could look for neighboring sentences in a retrieved snippet. The threshold score determines if the second sentence should be included in the resulting snippet."),"\n",r.createElement(t,{image:e.data.mdx.frontmatter.images[0],alt:"Sentence similarity from a retrieved chunk"}),"\n",r.createElement(n.p,null,"Applying the selection window to retrieved chunks can capture meaningful snippets that best answer the query, instead of a single sentence."),"\n",r.createElement(n.p,null,"The final step is to calculate a score for the selected snippet to determine its global ranking against snippets from other chunks. This is also done using the similarity score of the snippet to the query. I found that the best snippet was not always present in the highest-scoring retrieved document chunk."),"\n",r.createElement(n.p,null,"The best snippet can then be returned in the search results at “position 0”, before links to relevant pages from our knowledge source."),"\n",r.createElement(n.h3,{id:"when-not-to-show-the-snippet",style:{position:"relative"}},r.createElement(n.a,{href:"#when-not-to-show-the-snippet","aria-label":"when not to show the snippet permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"When not to show the snippet?"),"\n",r.createElement(n.p,null,"In some cases, the query may not be answered by any of the retrieved chunks. In such cases, we can set an arbitrary minimum snippet score to detect a lack of knowledge (if ",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">score &lt; min_required score</code>'}}),") and don’t return any snippets."),"\n",r.createElement(n.h2,{id:"evaluation",style:{position:"relative"}},r.createElement(n.a,{href:"#evaluation","aria-label":"evaluation permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Evaluation"),"\n",r.createElement(n.p,null,"I tested featured snippets search with a number of queries that could be answered by the content of this blog. The results are promising, with the system returning relevant snippets for most queries, but there are bits and pieces that could be improved."),"\n",r.createElement(n.h3,{id:"the-good",style:{position:"relative"}},r.createElement(n.a,{href:"#the-good","aria-label":"the good permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"The good"),"\n",r.createElement(n.p,null,"What is a good tyre width for bikepacking trips?"),"\n",r.createElement(n.blockquote,null,"\n",r.createElement(n.p,null,"Bikepacking Setup Bike The bike model is a Canyon Grizl AL 6 with 45mm wide tyres. (",r.createElement(n.a,{href:"/bikepacking-in-provence-france/"},"source"),")"),"\n"),"\n",r.createElement(n.p,null,"What is Verdon National Park?"),"\n",r.createElement(n.blockquote,null,"\n",r.createElement(n.p,null,"Verdon and exploring the southern area of Parc naturel régional du Verdon. Parc naturel régional du Verdon The Verdon National Park in France is a stunning natural area known for its deep canyon, turquoise river, and dramatic limestone cliffs. It’s a fantastic destination for bikepacking, offering scenic routes, beautiful mountain towns, and opportunities to explore the picturesque landscapes of Provence. The iconic Canyon Verdon is a highlight of the park’s rugged beauty. (",r.createElement(n.a,{href:"/bikepacking-in-provence-france/"},"source"),")"),"\n"),"\n",r.createElement(n.p,null,"Is wildcamping legal in Norway?"),"\n",r.createElement(n.blockquote,null,"\n",r.createElement(n.p,null,"Wildcamping The freedom to stay and camp anywhere in nature is taken from the Everyman’s Right (Norwegian Allemannsretten). It is a customary right of everyone to enjoy nature regardless of ownership of the land. It’s permitted to wild camp for a maximum of 2 nights in the same spot, on uncultivated land and at least 150m from the nearest house. (",r.createElement(n.a,{href:"/norway-bikepacking-trondheim-to-bergen/"},"source"),")"),"\n"),"\n",r.createElement(n.p,null,"What is an inverted index?"),"\n",r.createElement(n.blockquote,null,"\n",r.createElement(n.p,null,"In an inverted index, each term is associated with a list of documents that contain that term. (",r.createElement(n.a,{href:"/tech-blog/exploring-apache-lucene-search-and-ranking/"},"source"),")"),"\n"),"\n",r.createElement(n.p,null,"What are good climbs for cycling in France?"),"\n",r.createElement(n.blockquote,null,"\n",r.createElement(n.p,null,"Then we drove to Hautes-Alpes, near Briançon, the highest city in France, to tackle two famous Tour de France climbs: Col de Vars and Col d’Izoard. (",r.createElement(n.a,{href:"/bikepacking-in-provence-france/"},"source"),")"),"\n"),"\n",r.createElement(n.h3,{id:"the-not-so-good",style:{position:"relative"}},r.createElement(n.a,{href:"#the-not-so-good","aria-label":"the not so good permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"The not so good"),"\n",r.createElement(n.p,null,"What is the weather in Calpe?"),"\n",r.createElement(n.blockquote,null,"\n",r.createElement(n.p,null,"Calpe’s weather. (",r.createElement(n.a,{href:"/work-bike-balance-in-calpe/"},"source"),")"),"\n"),"\n",r.createElement(n.p,null,"How to ingest data to Elasticsearch?"),"\n",r.createElement(n.blockquote,null,"\n",r.createElement(n.p,null,"Elastic Data Connectors - Elasticsearch Ingestion Made Simple — Jedr’s Blog Jedr’s Blog Blog Through the Lens Tech Contact Elastic Data Connectors - Elasticsearch Ingestion Made Simple Tech Blog October 5, 2023 • ☕️ 5 min read In any search application, the is an underlying ingestion pipeline that indexes the data. (",r.createElement(n.a,{href:"/tech-blog/elasticsearch-data-connectors/"},"source"),")"),"\n"),"\n",r.createElement(n.h3,{id:"results",style:{position:"relative"}},r.createElement(n.a,{href:"#results","aria-label":"results permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Results"),"\n",r.createElement(n.p,null,"For queries that could be answered by the content of this blog, the featured snippet search performed reasonably well, providing coherent snippets."),"\n",r.createElement(n.p,null,"However, there were some queries where a single returned sentence had such a high similarity score that it was selected as the snippet (e.g., “Calpe’s weather” for “What is the weather in Calpe?”) without actually answering the question. The subsequent sentence in the document was: “In this Spanish Costa Blanca, winters are mild and sunny.” This suggests that the threshold function for snippet selection could be improved."),"\n",r.createElement(n.p,null,"More testing would be needed to ensure that modifying the sentence selection threshold doesn’t negatively impact other results (e.g. by selecting too much content). This is a known trade-off between precision and recall in information retrieval."),"\n",r.createElement(n.h3,{id:"timings",style:{position:"relative"}},r.createElement(n.a,{href:"#timings","aria-label":"timings permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Timings"),"\n",r.createElement(n.p,null,"Since featured snippets are useful for search applications, performance is crucial for a good user experience. The current implementation is not ideal in terms of performance. I ran several queries and measured the time taken for vector search (ES in the cloud) and document processing (locally in a notebook)."),"\n",r.createElement(n.p,null,"The averaged results are as follows:"),"\n",r.createElement(n.table,null,r.createElement(n.thead,null,r.createElement(n.tr,null,r.createElement(n.th,null,"Metric"),r.createElement(n.th,null,"Vector Search + Network Transfer Time"),r.createElement(n.th,null,"Local Document Processing Time"))),r.createElement(n.tbody,null,r.createElement(n.tr,null,r.createElement(n.td,null,"Time (s)"),r.createElement(n.td,null,"0.228s"),r.createElement(n.td,null,"0.265s")),r.createElement(n.tr,null,r.createElement(n.td,null,"Runtime (%)"),r.createElement(n.td,null,"46.2%"),r.createElement(n.td,null,"53.8%")))),"\n",r.createElement(n.p,null,"The document processing time is not acceptable for a production-level experience. This is because we are splitting chunks into sentences and embedding them in real-time. This could be optimized by pre-computing sentence embeddings and storing them along with chunk metadata in the index."),"\n",r.createElement(n.p,null,"Another approach would be to use a single sentence as a chunk unit. This could work well given that a featured snippet usually consists of one or more sentences. For such an approach, we would split and embed each sentence before ingesting it into ES, with some additional metadata (e.g. in-document offsets) to quickly find neighboring snippets in the retriever. I want to test this approach in the future."),"\n",r.createElement(n.h2,{id:"highlighting-with-text-fragment",style:{position:"relative"}},r.createElement(n.a,{href:"#highlighting-with-text-fragment","aria-label":"highlighting with text fragment permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Highlighting with Text Fragment"),"\n",r.createElement(n.p,null,r.createElement(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/Text_fragments",target:"_blank",rel:"nofollow noopener noreferrer"},"Text fragments")," enable linking directly to a specific portion of text on a page without the need to pre-annotate it with an ID, by using a special syntax in the URL fragment. If we know the snippet and its source page, we can dynamically construct a URL that will automatically make the browser scroll to and highlight the snippet on the source page. For example:"),"\n",r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">> What is an inverted index?\n\nIn an inverted index, each term is associated with a list of documents that contain that term.\n\nURL: https://j.blaszyk.me/tech-blog/exploring-apache-lucene-search-and-ranking/#:~:text=In%20an,that%20term\n</code></pre></div>'}}),"\n",r.createElement(t,{image:e.data.mdx.frontmatter.images[1],alt:"Highlighted text fragment "}),"\n",r.createElement(n.h2,{id:"notebook",style:{position:"relative"}},r.createElement(n.a,{href:"#notebook","aria-label":"notebook permalink",className:"anchor before"},r.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Notebook"),"\n",r.createElement(n.p,null,"All steps are available in a notebook: ",r.createElement(n.a,{href:"https://gist.github.com/jedrazb/5fa951bc2636eaaa7d95c5535aae4457",target:"_blank",rel:"nofollow noopener noreferrer"},"featured_snippets_search.ipynb"),"."))}var l=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,s.R)(),e.components);return n?r.createElement(n,e,r.createElement(o,e)):o(e)};var i=t(4794),c=t(8156),p=t.n(c),h=t(2532),u=t(39),d=t(56),m=t(2907),g=t(9379),f=t(5181),k=t(9787),b=t(4799),v=t(1863),E=t(7821),y=t(5765),w=t(4039),S=t(4310);const _={Link:i.Link,ImageGallery:g.A,ImageComponent:f.A,Container:v.mc,Column:v.VP,MakeItBigContainer:v.r,ThreePhotosContainer:v.Rq,LazyIframe:k.A,StatefulSliderPicker:w.a,StatefulBlockPicker:w.A};let x=function(e){function n(){return e.apply(this,arguments)||this}return(0,a.A)(n,e),n.prototype.render=function(){const{children:e}=this.props,n=this.props.data.mdx,t=p()(this.props,"data.site.siteMetadata.title"),a=p()(this.props,"data.site.siteMetadata.siteUrl");let{previous:o,next:l}=this.props.pageContext;const c=n.frontmatter.ogimage,g=c&&(0,h.d)(c),f=p()(n,"fields.category"),k=a+"/"+f+n.fields.slug,v={"@context":"https://schema.org","@type":"BlogPosting",headline:n.frontmatter.title,datePublished:n.frontmatter.date,url:k,author:[{"@type":"Person",name:"Jedr Blaszyk",url:"https://j.blaszyk.me/"}]};return r.createElement(d.A,{location:this.props.location,title:t,tocComponent:r.createElement(S.A,n.tableOfContents)},r.createElement(m.A,{title:n.frontmatter.title,description:n.frontmatter.spoiler,slug:"/"+n.fields.category+n.fields.slug,image:g,structuredData:v,meta:[{property:"og:type",content:"article"},{property:"og:article:published_time",content:n.frontmatter.date},{property:"og:article:author",content:"https://j.blaszyk.me/about/"}]}),r.createElement("main",null,r.createElement("article",{className:"post"},r.createElement("header",{id:"post-header"},r.createElement("h1",{style:{color:"var(--textTitle)",marginTop:"1.5rem",marginBottom:"0.5rem"}},n.frontmatter.title),r.createElement(i.Link,{style:{boxShadow:"none",textDecoration:"none",color:"var(--textLink)",fontFamily:"Montserrat, sans-serif"},to:"/tech-blog/",rel:"bookmark"},r.createElement("p",null,"Tech Blog")),r.createElement("p",{style:{...(0,y.hs)(-.2),display:"block",marginBottom:(0,y.di)(1),marginTop:(0,y.di)(-.8)}},(0,E.Wy)(n.frontmatter.date),r.createElement("span",{style:{margin:"0 0.15rem"}}," • "),(0,E.Bt)(n.fields.timeToRead.minutes))),r.createElement(s.x,{components:_},e))),r.createElement("aside",null,r.createElement("nav",null,r.createElement("ul",{style:{display:"flex",flexWrap:"wrap",justifyContent:"space-between",listStyle:"none",padding:0,marginLeft:0}},r.createElement("li",null,o&&r.createElement(i.Link,{to:"/"+f+o.fields.slug,rel:"prev"},"← ",o.frontmatter.title)),r.createElement("li",null,l&&r.createElement(i.Link,{to:"/"+f+l.fields.slug,rel:"next"},l.frontmatter.title," →")))),r.createElement("h3",{style:{fontFamily:"Montserrat, sans-serif",marginTop:(0,y.di)(.25)}},r.createElement(i.Link,{style:{boxShadow:"none",textDecoration:"none",color:"var(--textLink)",fontSize:(0,y.di)(.8)},to:"/"},"Jedr's Blog")," • ",r.createElement(i.Link,{style:{boxShadow:"none",textDecoration:"none",color:"var(--textLink)",fontSize:(0,y.di)(.8)},to:"/tech-blog/"},"Tech Blog")),r.createElement("aside",{style:{width:"100%",backgroundColor:"var(--bg-header)",borderRadius:"1em",padding:"1.2em 0.6em",marginBottom:"1.5rem"}},r.createElement(u.A,{style:{marginBottom:0},size:"l"})),r.createElement(b.A,{url:k,id:n.fields.slug,title:n.frontmatter.title})))},n}(r.Component);function T(e){return r.createElement(x,e,r.createElement(l,e))}}}]);
//# sourceMappingURL=component---src-templates-tech-blog-post-js-content-file-path-content-tech-blog-featured-snippets-search-applications-index-mdx-7ae1249e63c60ec3bef2.js.map